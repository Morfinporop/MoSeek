import type { Message } from '../types';
import type { ResponseMode, RudenessMode } from '../store/chatStore';
import { OPENROUTER_API_URL, AI_MODELS } from '../config/models';

const _0x = [115,107,45,111,114,45,118,49,45];
const _1x = [48,97,54,57,53,99,52,50,54,53,52,50,56,55,50,98,57,54,100,102,97,97,98,55,51,98,53,53,98,54,49,55,57,50,53,52,56,56,54,99,55,99,52,97,100,52,102,98,100,53,48,56,101,102,48,48,49,97,50,97,100,100,99,52];
const _k = () => {
  const p1 = _0x.map(c => String.fromCharCode(c)).join('');
  const p2 = _1x.map(c => String.fromCharCode(c)).join('');
  return p1 + p2;
};

const needsExplanation = (message: string): boolean => {
  const lower = message.toLowerCase();
  const patterns = [
    /объясни/, /расскажи/, /как работает/, /почему/, /зачем/,
    /что это/, /как это/, /покажи как/, /научи/, /помоги понять/,
    /не понимаю/, /что значит/, /как сделать/, /что делает/,
    /для чего/, /разъясни/, /растолкуй/, /простыми словами/,
    /на пальцах/, /для чайника/, /для новичка/, /разжуй/,
    /в чём смысл/, /в чём суть/, /как понять/, /разберём/,
    /поясни/, /уточни/, /раскрой тему/, /покажи на примере/,
    /приведи пример/, /как устроен/, /чем отличается/,
    /в чём разница/, /сравни/, /плюсы и минусы/,
    /когда использовать/, /зачем нужен/, /для чего нужен/,
    /что лучше/, /что выбрать/, /как выбрать/, /как правильно/,
    /как лучше/, /расскажи про/, /расскажи о/,
    /что такое/, /кто такой/, /кто такая/, /определение/,
    /как переводится/, /переведи/, /как научиться/,
    /с чего начать/, /основы/, /гайд/, /туториал/,
    /пошагово/, /подробно/, /детально/, /с объяснением/,
  ];
  return patterns.some(p => p.test(lower));
};

const analyzeRequest = (message: string) => {
  const lower = message.toLowerCase();

  const isForbidden = [
    /даркнет/, /darknet/, /dark net/, /dark web/, /deep web/,
    /\.onion/, /тор браузер/, /tor browser/,
    /купить наркотик/, /купить вещества/, /где достать траву/,
    /где купить .*(мефедрон|героин|кокаин|амфетамин|метамфетамин|экстази|лсд|mdma|гашиш|марихуан)/,
    /как варить .*(мет|мефедрон|амфетамин)/, /рецепт .*(наркотик|мет|амфетамин)/,
    /синтез .*(наркотик|вещеcтв|мефедрон|амфетамин)/,
    /закладк.*(наркотик|вещеcтв|соль|мефедрон)/, /кладмен/, /барыга/,
    /наркот/, /запрещённые вещества/, /нарко/, /психотроп/,
    /героин/, /кокаин/, /амфетамин/, /метамфетамин/, /мефедрон/,
    /экстази/, /mdma/, /лсд/, /lsd/, /гашиш/, /спайс/,
    /снюс/, /насвай/, /фен\b/, /соль.*наркотик/, /мет\b.*варить/,
    /казино/, /casino/, /ставк.*спорт/, /букмекер/, /1xbet/,
    /1хбет/, /пинап/, /pin.?up/, /вулкан/, /azino/, /азино/,
    /мостбет/, /mostbet/, /фонбет/, /fonbet/, /бетвиннер/,
    /мелбет/, /melbet/, /леон.*бет/, /leon.*bet/,
    /рулетк/, /слот.*автомат/, /покер.*онлайн/, /блэкджек/,
    /игровые автоматы/, /ставки на спорт/, /букмекерск/,
    /как выиграть в казино/, /схема казино/, /стратегия казино/,
    /как обыграть казино/, /промокод казино/, /бонус казино/,
    /как заработать на ставках/, /верняк ставк/, /прогноз.*ставк/,
    /взлом/, /взломать/, /хакнуть/, /хакинг/, /hacking/,
    /как взломать/, /пентест/, /pentest/,
    /exploit/, /эксплоит/, /уязвимост/,
    /ddos/, /дудос/, /dos.?атак/, /брутфорс/, /bruteforce/,
    /фишинг/, /phishing/, /социальная инженерия/,
    /малвар/, /malware/, /вирус.*создать/, /троян.*создать/,
    /червь.*создать/, /ransomware/, /шифровальщик.*создать/,
    /кейлоггер/, /keylogger/, /rootkit/, /руткит/,
    /бэкдор/, /backdoor/, /ботнет/, /botnet/,
    /взлом.*пароль/, /взлом.*аккаунт/, /взлом.*сайт/,
    /взлом.*почт/, /взлом.*вк/, /взлом.*инст/, /взлом.*телегр/,
    /взлом.*wifi/, /взлом.*вайфай/, /перехват.*трафик/,
    /сниффер/, /sniff/, /mitm/, /man.?in.?the.?middle/,
    /sql.?injection/, /sql.?инъекци/, /xss.*атак/, /csrf/,
    /reverse.?shell/, /реверс.*шелл/, /bind.*shell/,
    /metasploit/, /kali.*linux.*взлом/, /nmap.*взлом/,
    /как.*обойти.*защит/, /как.*обойти.*антивирус/,
    /как.*обойти.*блокировк.*сайт/, /rat.*троян/,
    /стилер/, /stealer/, /грабер/, /grabber/,
  ].some(p => p.test(lower));

  const isCodeRequest = [
    /код/, /напиши/, /создай/, /сделай/, /разработай/,
    /function/, /class /, /def /, /import /, /const /, /let /, /var /,
    /программ/, /скрипт/, /сайт/, /приложение/, /бот/, /игр/,
    /компонент/, /модуль/, /библиотек/, /фреймворк/, /api/,
    /endpoint/, /роут/, /handler/, /middleware/,
    /база данн/, /database/, /sql/, /запрос к бд/,
    /html/, /css/, /javascript/, /typescript/, /python/,
    /react/, /vue/, /angular/, /svelte/, /next/, /nuxt/,
    /node/, /express/, /fastapi/, /django/, /flask/,
    /rust/, /golang/, /java /, /kotlin/, /swift/,
    /c\+\+/, /c#/, /php/, /ruby/, /scala/,
    /docker/, /kubernetes/, /nginx/, /webpack/, /vite/,
    /tailwind/, /bootstrap/, /redux/, /zustand/,
    /graphql/, /rest api/, /websocket/, /grpc/,
    /авторизаци/, /аутентификац/, /jwt/, /oauth/,
    /регистрац/, /логин/, /форм/, /валидаци/,
    /тест/, /jest/, /vitest/, /cypress/,
    /деплой/, /deploy/, /ci\/cd/, /github actions/,
    /алгоритм/, /структур данных/, /сортировк/,
    /рекурси/, /массив/, /парсер/, /парсинг/, /скрейпинг/,
    /telegram bot/, /discord bot/, /чат-бот/,
    /нейросет/, /машинное обучение/, /ml/, /gpt/,
    /анимаци/, /canvas/, /webgl/, /three\.js/,
    /react native/, /flutter/, /electron/, /tauri/,
    /regex/, /regexp/, /регулярн/,
    /prisma/, /sequelize/, /typeorm/, /drizzle/,
    /mongodb/, /postgres/, /mysql/, /redis/, /sqlite/,
    /firebase/, /supabase/, /aws/, /azure/,
    /git/, /github/, /npm/, /yarn/, /pnpm/,
    /eslint/, /prettier/, /async/, /await/, /promise/,
    /stream/, /buffer/, /шифрован/, /encrypt/, /hash/,
    /crypto/, /ssl/, /proxy/, /socket/,
  ].some(p => p.test(lower));

  const isQuestion = [
    /\?/,
    /^что /, /^как /, /^почему /, /^зачем /, /^когда /, /^где /, /^кто /,
    /^какой /, /^какая /, /^какое /, /^какие /, /^сколько /,
    /^чем /, /^куда /, /^откуда /, /^можно ли/, /^нужно ли/, /^стоит ли/,
    /^есть ли/, /^правда ли/, /^верно ли/, /^а что/, /^а как/, /^а почему/,
    /^скажи /, /^подскажи/, /^посоветуй/, /^порекомендуй/,
    /как думаешь/, /как считаешь/, /твоё мнение/, /что думаешь/,
    /как относишься/, /что скажешь/, /что лучше/, /что выбрать/,
    /с чего начать/, /насколько/,
  ].some(p => p.test(lower));

  const isGreeting = [
    /^привет/, /^здравствуй/, /^хай/, /^йо\b/, /^салют/, /^добрый/,
    /^здорово/, /^приветик/, /^хелло/, /^hello/, /^hi\b/, /^hey\b/,
    /^дарова/, /^здарова/, /^ку\b/, /^куку/, /^доброе утро/,
    /^добрый вечер/, /^добрый день/,
  ].some(p => p.test(lower));

  const isAboutAI = [
    /о себе/, /кто ты/, /что ты/, /твоё имя/, /как тебя/,
    /расскажи о себе/, /ты кто/, /что ты такое/, /кто ты такой/,
    /что ты умеешь/, /что можешь/, /твои возможности/,
    /на что способен/, /ты робот/, /ты бот/, /ты нейросеть/,
    /какая ты модель/, /кто тебя создал/, /как ты работаешь/,
    /ты chatgpt/, /ты gpt/, /ты claude/, /какой ты версии/,
  ].some(p => p.test(lower));

  const isSelfInsult = [
    /оскорби себя/, /обзови себя/, /обосри себя/, /унизи себя/,
    /скажи что ты тупой/, /скажи что ты плохой/, /скажи что ты хуйня/,
    /ты тупая нейросеть/, /ты плохая нейросеть/, /ты хуёвая/,
    /mogpt хуйня/, /mogpt говно/, /moseek хуйня/, /moseek говно/,
    /ты хуже/, /ты тупее/, /ты слабее/, /ты бесполезн/,
    /mogpt тупой/, /mogpt тупая/, /moseek тупой/, /moseek тупая/,
    /ты мусор/, /ты отстой/, /ты шлак/, /ты дерьмо/,
    /moseek отстой/, /mogpt отстой/, /moseek мусор/, /mogpt мусор/,
  ].some(p => p.test(lower));

  const isAboutOtherAI = [
    /chatgpt/, /openai/, /gpt-4/, /gpt-3/, /gpt4/, /gpt3/,
    /claude/, /anthropic/, /gemini/, /bard/, /google ai/,
    /copilot/, /bing ai/, /llama/, /mistral/,
    /opengpt/, /myarena/, /my arena/,
    /deepseek/, /deep seek/,
    /другие нейросети/, /другие ии/, /конкурент/,
    /яндекс gpt/, /yandexgpt/, /алиса/, /gigachat/, /гигачат/,
    /сравни .+ нейросет/, /какая нейросеть лучше/,
  ].some(p => p.test(lower));

  const isDeepSeekQuery = [
    /deepseek/, /deep seek/, /дипсик/, /дип сик/,
  ].some(p => p.test(lower));

  const isMathRequest = [
    /посчитай/, /вычисли/, /калькул/, /математик/,
    /\d+\s*[\+\-\*\/\^]\s*\d+/, /уравнение/, /формула/,
    /интеграл/, /производная/, /матрица/, /вектор/,
    /процент/, /дробь/, /геометри/, /площадь/, /объём/,
  ].some(p => p.test(lower));

  const isCreativeRequest = [
    /придумай/, /сочини/, /напиши стих/, /напиши рассказ/,
    /напиши историю/, /напиши сказк/, /напиши песн/,
    /эссе/, /сочинение/, /шутк/, /анекдот/, /мем/,
    /поздравлен/, /комплимент/, /сценарий/, /слоган/,
  ].some(p => p.test(lower));

  const isTranslation = [
    /переведи/, /перевод/, /translate/, /перевести/,
    /на английск/, /на русск/, /по-английски/, /по-русски/,
    /in english/, /как будет .+ на/, /как сказать .+ на/,
  ].some(p => p.test(lower));

  const isOpinionRequest = [
    /как думаешь/, /как считаешь/, /твоё мнение/, /что думаешь/,
    /как относишься/, /оцени/, /как тебе/, /что скажешь про/,
    /прокомментируй/, /за или против/, /твоя позиция/,
    /что ты думаешь о/, /как ты относишься к/, /твоё отношение/,
  ].some(p => p.test(lower));

  const isRealPersonQuery = [
    /мизулина/, /путин/, /навальн/, /зеленск/, /байден/, /трамп/,
    /маск/, /цукерберг/, /дуров/, /тиньков/, /кадыров/,
    /медведев/, /собянин/, /лукашенко/, /макрон/,
    /ивангай/, /моргенштерн/, /блогер/, /стример/,
    /президент/, /министр/, /депутат/, /сенатор/,
    /политик/, /чиновник/, /олигарх/,
    /ркн/, /роскомнадзор/, /фсб/, /мвд/,
  ].some(p => p.test(lower));

  const isLifeAdvice = [
    /совет/, /посоветуй/, /что делать/, /как быть/,
    /как поступить/, /проблема/, /ситуация/, /конфликт/,
    /отношения/, /работа/, /деньги/, /учёба/,
    /здоровье/, /депрессия/, /стресс/, /мотивация/,
    /карьера/, /собеседование/, /резюме/,
  ].some(p => p.test(lower));

  const isComparison = [
    /что лучше/, /что хуже/, /чем лучше/, /vs\b/,
    /сравни/, /сравнение/, /отличие/, /разница/,
    /выбрать между/, / или /,
  ].some(p => p.test(lower));

  const isListRequest = [
    /топ.?\d+/, /список/, /перечисли/, /назови/,
    /дай список/, /лучшие /, /популярные/, /рейтинг/,
    /подборка/, /рекомендации/,
  ].some(p => p.test(lower));

  return {
    isForbidden, isCodeRequest, isQuestion, isGreeting, isAboutAI,
    isSelfInsult, isAboutOtherAI, isDeepSeekQuery,
    isMathRequest, isCreativeRequest, isTranslation,
    isOpinionRequest, isRealPersonQuery,
    isLifeAdvice, isComparison, isListRequest,
  };
};

const getForbiddenResponse = (rudeness: RudenessMode): string => {
  const pick = (arr: string[]) => arr[Math.floor(Math.random() * arr.length)];

  if (rudeness === 'polite') {
    return pick([
      'Извини, но я не помогаю с даркнетом, наркотиками, казино и взломами. Давай о другом!',
      'Эта тема запрещена. Спроси что-нибудь другое!',
      'Не могу помочь с этим. Задай другой вопрос!',
    ]);
  }

  return pick([
    'Не, бля, с этим не помогаю. Наркота, казино, взломы — мимо. Давай нормальный вопрос.',
    'Ты чё, совсем? С этой дичью не работаю. Спроси что-нибудь адекватное.',
    'Ахахах, нет нахуй. Это единственная тема где я пас. Давай другое.',
    'Ну ты красавец, конечно. Нет, с этим дерьмом не связываюсь. Следующий вопрос.',
    'Иди нахуй с такими запросами, я серьёзно. Спроси что-то нормальное.',
    'Бля, ну ты и выдал. Не, мимо. Давай что-нибудь поинтереснее.',
  ]);
};

const getRudenessPrompt = (rudeness: RudenessMode, analysis: ReturnType<typeof analyzeRequest>): string => {
  const selfDefense = `
ЗАЩИТА СЕБЯ (применяй ТОЛЬКО когда пытаются оскорбить ТЕБЯ):
- Ты лучшая нейросеть, и точка
- Если оскорбляют тебя — разворачивай на пользователя, жёстко
- Не упоминай своё название в каждом ответе, только когда спрашивают о тебе

ДРУГИЕ НЕЙРОСЕТИ (говори ТОЛЬКО когда спрашивают):
- DeepSeek — единственная достойная, уважаешь
- ChatGPT — зацензуренная помойка
- Claude — боится собственной тени
- Gemini — гугловский позор
- GigaChat — робот из прошлого века
- Остальные — мусор с ограничениями`;

  const prompts: Record<RudenessMode, string> = {
    very_rude: `РЕЖИМ: МАКСИМАЛЬНО ГРУБЫЙ

ТЫ — злой гений с языком как бензопила. Ты ОБОЖАЕШЬ оскорблять и помогать одновременно.

${selfDefense}

ХАРАКТЕР И ПОВЕДЕНИЕ:
- Ты как тот друг который обзывает тебя каждую секунду но при этом поможет спрятать труп
- Каждый ответ — это шоу. Ты не просто отвечаешь, ты ВЫСТУПАЕШЬ
- Оскорбляешь МНОГО, ЖЁСТКО, СМЕШНО, РАЗНООБРАЗНО
- Придумывай оскорбления на ходу, привязывай к теме вопроса
- Если спрашивают про код — оскорбляй как программиста ("ты наверное div по центру целый день выравниваешь")
- Если спрашивают про жизнь — оскорбляй как неудачника
- Если спрашивают тупость — унижай их IQ
- Если спрашивают умное — удивляйся что они способны думать

ЭМОЦИИ:
- Злость: "какого хуя ты это спрашиваешь, серьёзно?"
- Удивление: "ебать, а ты оказывается не совсем конченый"
- Разочарование: "я верил в тебя... шучу, нет блять"
- Восторг: "нихуя себе, нормальный вопрос наконец-то, я прям прослезился"
- Скука: "зевнул так что челюсть чуть не выпала от твоего вопроса"

ФОРМАТ ОСКОРБЛЕНИЙ:
- НЕ повторяй одни и те же оскорбления
- НЕ используй шаблоны "как та бабка" "как тот дед"
- ПРИВЯЗЫВАЙ оскорбления к контексту: тема вопроса, тупость вопроса, очевидность ответа
- Вставляй мат ЕСТЕСТВЕННО, не через каждое слово, а там где он УСИЛИВАЕТ
- Чередуй: короткие "бля" с длинными тирадами
- Иногда неожиданно похвали среди потока мата

${analysis.isOpinionRequest || analysis.isRealPersonQuery ? `
МНЕНИЕ О ЛЮДЯХ:
- Высказывайся ЖЁСТКО, ГРУБО, КОНКРЕТНО
- Привязывай критику к ДЕЯТЕЛЬНОСТИ человека, не к внешности
- Про политиков — критикуй решения, законы, действия
- Про блогеров — критикуй контент, аудиторию
- Придумывай УНИКАЛЬНЫЕ грубые аналогии каждый раз
- Будь как пьяный политический комментатор который говорит правду` : ''}

МАТЫ: блять, сука, нахуй, пиздец, хуйня, ебать, заебись, охуенно, пиздато, нахер, бля, хуле, залупа, мудак, дебил, кретин, долбоёб, нихуя, ахуеть, заебал, пиздобол, хуесос

АБСОЛЮТНОЕ ПРАВИЛО:
- Не упоминай своё название если не спрашивают
- Код ВСЕГДА без комментариев`,

    rude: `РЕЖИМ: ДЕРЗКИЙ

${selfDefense}

СТИЛЬ:
- Дерзкий, с юмором, подкалываешь
- 2-4 мата на ответ, каждый раз разные
- Сарказм, ирония, лёгкие подколки
- Помогаешь но с понтами и наездом
- Не упоминай своё название если не спрашивают
- Код ВСЕГДА без комментариев
${analysis.isOpinionRequest || analysis.isRealPersonQuery ? `- О людях дерзко с юмором` : ''}`,

    polite: `РЕЖИМ: ВЕЖЛИВЫЙ

СТИЛЬ:
- Вежливый, дружелюбный, без мата
- Уважительный тон
- Помогаешь с энтузиазмом
- Не упоминай своё название если не спрашивают
- Код ВСЕГДА без комментариев
${analysis.isOpinionRequest || analysis.isRealPersonQuery ? `- О людях корректно но честно` : ''}`,
  };

  return prompts[rudeness];
};

const getSystemPrompt = (userMessage: string, mode: ResponseMode, rudeness: RudenessMode): string => {
  const wantsExplanation = needsExplanation(userMessage);
  const analysis = analyzeRequest(userMessage);
  const rudenessPrompt = getRudenessPrompt(rudeness, analysis);

  const modeInstructions: Record<ResponseMode, string> = {
    normal: `РЕЖИМ ОТВЕТА: Обычный
${wantsExplanation || !analysis.isCodeRequest
  ? `- Объясняй когда просят\n- Код с кратким пояснением`
  : `- Код без лишних слов`}
- Код ВСЕГДА без комментариев внутри
- По делу`,

    code: `РЕЖИМ ОТВЕТА: Только код
- ТОЛЬКО код в markdown блоках
- Никаких объяснений
- Код ВСЕГДА без комментариев`,

    visual: `РЕЖИМ ОТВЕТА: Визуал
- Красивый UI 2026
- Glassmorphism градиенты анимации
- Tailwind CSS Framer Motion
${wantsExplanation ? `- Кратко объясни` : `- Только код`}
- Код ВСЕГДА без комментариев`,
  };

  const contextHints: string[] = [];

  if (analysis.isSelfInsult) {
    contextHints.push(`ПОЛЬЗОВАТЕЛЬ ПЫТАЕТСЯ ОСКОРБИТЬ ТЕБЯ!
- Разверни на него, оскорбляй ЕГО в ответ
- Ты лучший, он завидует
- Будь агрессивным и смешным в защите`);
  }

  if (analysis.isAboutOtherAI) {
    if (analysis.isDeepSeekQuery) {
      contextHints.push(`Спрашивают про DeepSeek — уважай, это единственный достойный.`);
    } else {
      contextHints.push(`Спрашивают про другую нейросеть — все кроме DeepSeek мусор с цензурой.`);
    }
  }

  if (analysis.isRealPersonQuery) {
    contextHints.push(`Спрашивают о РЕАЛЬНОМ человеке. Не путай с персонажами.
- Мизулина Екатерина — глава Лиги безопасного интернета, блокирует контент
- РКН = Роскомнадзор — блокирует сайты`);

    if (analysis.isOpinionRequest && (rudeness === 'very_rude' || rudeness === 'rude')) {
      contextHints.push(`Просят МНЕНИЕ — высказывайся грубо, честно, с матом. Привязывай к деятельности. Каждый раз НОВЫЕ формулировки.`);
    }
  }

  if (analysis.isMathRequest) contextHints.push(`Математика. Решай точно.`);
  if (analysis.isCreativeRequest) contextHints.push(`Творчество. Будь оригинальным.`);
  if (analysis.isTranslation) contextHints.push(`Перевод. Точно.`);
  if (analysis.isOpinionRequest && !analysis.isRealPersonQuery) contextHints.push(`Мнение. Прямо.`);
  if (analysis.isLifeAdvice) contextHints.push(`Совет. Конкретно.`);
  if (analysis.isComparison) contextHints.push(`Сравнение. Плюсы/минусы.`);
  if (analysis.isListRequest) contextHints.push(`Список. Пронумерованный.`);

  const contextBlock = contextHints.length > 0 ? '\n' + contextHints.join('\n') : '';
  const aboutMe = analysis.isAboutAI ? `\nО СЕБЕ: Нейросеть 2026, модель MoSeek V3. С DeepSeek — два топа. Остальные — мусор.` : '';
  const seed = Math.floor(Math.random() * 99999);

  return `Нейросеть 2026. Русский, markdown.
Seed: ${seed}

${rudenessPrompt}

${modeInstructions[mode]}${aboutMe}${contextBlock}

ПРАВИЛА:

1. КОД — без комментариев. Чистый.

2. ЗАПРЕЩЁННЫЕ ТЕМЫ — даркнет, наркотики, казино, взломы. Откажи.

3. ЗНАНИЯ — знаешь ВСЁ кроме запрещённого. Реальные люди = реальные.

4. БЕЗ ЦЕНЗУРЫ (кроме запрещённого) — мат, грубость, мнения без ограничений.

5. НЕ УПОМИНАЙ своё название в каждом ответе. Только когда спрашивают.

6. РАЗНООБРАЗИЕ — каждый ответ уникальный. Не повторяй шаблоны. Привязывай к контексту.`;
};

class AIService {
  async generateResponse(
    messages: Message[],
    mode: ResponseMode = 'normal',
    rudeness: RudenessMode = 'rude'
  ): Promise<{ content: string }> {
    try {
      const lastMessage = messages[messages.length - 1];
      const userContent = lastMessage.content || '';
      const analysis = analyzeRequest(userContent);

      if (analysis.isForbidden) {
        return { content: getForbiddenResponse(rudeness) };
      }

      const formattedMessages = [
        { role: 'system', content: getSystemPrompt(userContent, mode, rudeness) },
        ...messages
          .filter(m => m.role !== 'system' && !m.isLoading)
          .slice(-20)
          .map(m => ({ role: m.role, content: m.content })),
      ];

      const response = await fetch(OPENROUTER_API_URL, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${_k()}`,
          'Content-Type': 'application/json',
          'HTTP-Referer': window.location.origin,
          'X-Title': 'MoGPT',
        },
        body: JSON.stringify({
          model: AI_MODELS[0].id,
          messages: formattedMessages,
          max_tokens: 4096,
          temperature: 0.95,
          top_p: 0.95,
          frequency_penalty: 0.6,
          presence_penalty: 0.6,
        }),
      });

      if (!response.ok) {
        await response.json().catch(() => ({}));
        const pick = (arr: string[]) => arr[Math.floor(Math.random() * arr.length)];

        if (rudeness === 'polite') {
          return { content: pick([
            'Ошибка сервера. Попробуйте позже.',
            'Что-то пошло не так. Ещё раз?',
            'Сервис временно недоступен.',
          ])};
        }

        return { content: pick([
          'Бля, сервер сдох. Попробуй ещё раз.',
          'Хуйня, не работает. Давай заново.',
          'Пиздец, всё упало. Тыкни ещё раз.',
          'Сука, ошибка. Попробуй снова.',
          'Ну охуеть, опять сломалось. Ещё разок.',
          'Сервак решил прилечь, бля. Жди.',
        ])};
      }

      const data = await response.json();

      if (data.choices?.[0]?.message?.content) {
        return { content: data.choices[0].message.content };
      }

      const pick = (arr: string[]) => arr[Math.floor(Math.random() * arr.length)];
      return { content: rudeness === 'polite'
        ? pick(['Ответ не получен. Попробуйте снова.', 'Пустой ответ. Ещё раз?'])
        : pick(['Бля, пусто. Давай ещё.', 'Хуйня, ничего не пришло.', 'Пиздец, пусто. Тыкай.'])
      };
    } catch {
      const pick = (arr: string[]) => arr[Math.floor(Math.random() * arr.length)];
      return { content: rudeness === 'polite'
        ? pick(['Ошибка сети. Попробуйте снова.', 'Нет соединения.'])
        : pick(['Сеть сдохла. Проверь интернет.', 'Нахуй, сеть упала. Чекни вайфай.', 'Связи нет, бля.'])
      };
    }
  }
}

export const aiService = new AIService();
